# 需要修改的地方

## 大纲

**注** 目标函数变了，现在求得的时间不是最优值了，难道只能是重新乘？

- [ ] ~~改变每次转移求解cost的方式~~ 多机器人的时候，会取max，导致部分机器人空闲，如何用 MILP 做呢？

- [ ] 分步骤实现baseline
  - [x] 得到多机器人 TS **注** 这步很重要，因为我们在PBA转移的时候，需要遍历哪些没有在执行ap的机器人的可能状态，有了TS之后，就会很容易得到这些状态 （查表的复杂度），而不用模拟那些空闲机器人的移动。
    - [x] 顺便获得时间，以后分析用
    - [x] 合理利用单个机器人的自环
      - [x] MultiTS 中就不包含自环了 （自环就是机器人全部静止，浪费时间）

  - [x] 得到多任务的 DFA，然后按照所有的 constraints 裁剪 **剪枝**
  - [x] PBA的转移生成
    - [x] 根据可能的DFA状态，去TS里搜相应的节点，然后把序列、cost存起来
    - [x] 希望一天能搞定！！！
- [ ] 展示：随机性的引入，主要体现在方差上，可以先不考虑，即固定了所有障碍物的位置，并得出一个结论；后续这些固定的可以作为模板，之后设计随机位置的时候参考。

- [x] 不能在同一个转移的判定中修改constrain，否则会撞车 - 好像也不是这个原因
- [ ] 输出的路径要有任务分配

## 细节

- [x] ~~类的坐标都是3D，需要填一个z=1：目前先保留，不确定之后会不会考虑三维空间/小飞机~~
- [x] multi-ts
  - [x] 以前写过，复用 - 还是直接利用network x吧，我相信里面也会存一个邻接矩阵/表
- [x] multi-dfa
  - [x] 把以前写的全乘起来，复用mp里的判定条件

- [x] 要写一个真正能用的DFS了，争取把DFS搞懂
  - **注** 不要一边搜索、一边修改图

## Bug

- [x] 出现了不应该有的DFA同时转移
  - [x] 断点 `i == 1 and node1[0][1] != "e" and  node1[1][1] != "e" and  node2[0][1] == "e" and  node2[1][1] == "e"` ，不会出现，不是DFA构造的问题
  - **注** 原因是，nx.shortest_path搜路的时候，如果起点和终点相同，只会返回一个点
- [ ] 如果只关心了make span的指标时，我们得到的可能不是路径最短的解，是否要考虑扩充目标函数

- [ ] baseline 在任务数达到5的时候会报错
  - [x] 检查发现，MultiDFA没有从初始节点到可接受节点的路径，可能的原因：
    - [x] 依赖设置得冲突了，**很有可能！** 删掉全部的依赖，就可以正常得到路径了
      - [x] 我的算法不能处理 es 😂 - 吐血，在写更新条件的时候，少复制了一行，可笑
    - [x] 任务中的命题冲突了？


- [ ] DFA的tqdm比真实的节点数大很多
![alt text](20241230_111230_481.png)

- [ ] 3个机器人的时候，PBA构造不动了
![alt text](20250101_090114_980.png)
- [ ] 分析必要性：
  - 因为我涉及了auction，所以必须有多个机器人？ 不一定，一个机器人多个拍品也可以体现出auction的感觉
  - 先把能写的写完，然后再看怎么优化实验，不要再花时间跑实验了！
    - 4.3.2，跑半个小时都跑不完



## Branches

1. 一个机器人，一个时间步，是否可以完成属于两个任务的ap
   1. 希望可以：enable multi_PBA.py 的 find_successor 函数的is_match，即注释部分
   2. 希望不可以：
      1. 本来想用哈希来做，但是如果有些任务要求比较宽松、有些任务要求比较严苛，按任务顺序判定就容易出错。
      2. 改成了comb的方法

## Pipeline

- [x] 搞几个场景，做一下对比

- [ ] n=x.y.z
  - x表示环境大小，y表示机器人数量，z表示任务数量
    - ap数量不是很关键，因为任务用到的就那么多，多了也只会增加MultiTS的数量，没有意义，结果上来看，差别应该不大
    - 把ap位置换成随机均匀生成的
    - ap数与任务数的对应
      - 任务：2， ap：3，依赖数：暂无标准
      - 任务：3， ap：4
      - 任务：4， ap：5
      - 任务：5， ap：6

## 学术诚信

## 有必要讨论但是不重要

1. 是不是只有节点可重复时才会出现多个可接受节点？

## 实验记录

n=6 跑不动
![alt text](20241222_111220_444.png)

## 实验结果

### env_size
![alt text](20250102_050117_121.png)

## 犯蠢时刻

shutill.copytree() 要自动创建文件夹，所以要先删除文件夹！！！